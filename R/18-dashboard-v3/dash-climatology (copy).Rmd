---
title: "CliRSnow"
output: 
  flexdashboard::flex_dashboard:
    storyboard: true
    self_contained: false
    lib_dir: libs
    theme: bootstrap
    orientation: rows
    vertical_layout: fill
    social: menu
    source: embed
    logo: media/logo_72x48.png
    navbar:
      - { title: "Back to main dashboard", href: "./index.html", align: right }
      - { title: "Back to CliRSnow homepage", href: "/", align: right }
---

```{r setup, include=FALSE}
library(flexdashboard)
library(leaflet)
library(mapview)

library(sf)
library(stars)
library(ggplot2)
library(dplyr)
```





### Station snow depth

```{r }

dat_meta_cluster <- readRDS(here::here("data/meta-with-cluster-01.rds"))
sf_meta <- st_as_sf(dat_meta_cluster,
                    coords = c("Longitude", "Latitude"),
                    crs = 4326)
sf_meta <- sf_meta %>% mutate(Region = cluster_fct)
# sf_meta <- sf_meta %>% mutate(lbl = paste0(Name, " (", Elevation, "m)"))


sf_borders <- st_as_sf(maps::map("world", plot = F, fill = T)) %>% 
  dplyr::filter(ID %in% c("Austria", "France", "Germany",
                          "Italy", "Slovenia", "Switzerland",
                          "Croatia", "Hungary", "Czech Republic",
                          "Slovakia"))

sf_borders2 <- sf_borders %>% 
  mutate(geom = st_cast(geom, "MULTILINESTRING")) %>% 
  # st_crop(sf_meta)
  st_crop(c(xmin = 4.5, ymin = 42.9, xmax = 18, ymax = 49.5))

gg <- ggplot()+
  # borders()+
  geom_sf(data = sf_borders2)+
  geom_sf(data = sf_meta, aes(colour = Region, shape = Region))+
  xlab(NULL)+ylab(NULL)+
  scale_x_continuous(labels = function(x) paste0(x, "° E"))+
  scale_y_continuous(labels = function(x) paste0(x, "° N"))+
  coord_sf(xlim = range(dat_meta_cluster$Longitude), ylim = range(dat_meta_cluster$Latitude))+
  theme_bw()+
  # theme(# legend.position = c(0.65, 0.15),
  #   legend.position = "top",
  #   # legend.title = element_blank(),
  #   legend.background = element_rect(colour = "grey"),
  #   # legend.direction = "horizontal",
  #   legend.box.just = "right")+
  scale_shape("")+
  scale_color_brewer("", palette = "Set1")+
  ggtitle("Regionalization of snow depth stations")


plotly::ggplotly(gg, tooltip = "shape")

```

*** 

Statistical grouping of the station observations of snow depth:

An automatic procedure (clustering) based solely on daily snow depth observations from December to April. No information on location or elevation entered into the clustering procedure, so the resulting groups are based solely on the similarity in daily snow depths across 30 years (1981-2010). 

Note that because it is a fully automatic procedure, no relabeling was performed, and some stations might seem to belong to the "wrong" group, but actually they have no similar neighbors in their or other clusters.


### Snow cover duration from Earth Observation

```{r}

rs_clim <- read_stars(here::here("data/modis_scd.tif"))
rs_clim_anom <- read_stars(here::here("data/modis_scd_anom.tif"))

ds_stars <- 10 # for template
# ds_stars <- 5 # for production 2-5



##graticules 

prj <- st_crs(rs_clim)$proj4string

lons <- seq(10, 12, by = 2)
lats <- seq(46, 48, by = 1)
xl <- range(lons) + c(-0.4, 0.4)
yl <- range(lats) + c(-0.4, 0.4)
grat <- graticule::graticule(lons, lats, proj = prj, xlim = xl, ylim = yl)
# labs <- graticule_labels(lons, lats, xline = min(xl), yline = max(yl), proj = prj)




# plots

ggplot()+
  geom_sf(data = st_as_sf(grat), colour = NA)+
  geom_stars(data = rs_clim, downsample = ds_stars)+
  scico::scale_fill_scico("[days]", limits = c(0, 366),
                   palette = "davos", na.value = NA, direction = 1)+
  coord_sf(expand = F)+
  theme_minimal()+
  xlab(NULL)+ylab(NULL)+
  scale_x_continuous(labels = function(x) paste0(x, "° E"))+
  scale_y_continuous(labels = function(x) paste0(x, "° N"))+
  ggtitle("Average Snow Cover Duration 2000-2020")


ggplot()+
  geom_sf(data = st_as_sf(grat), colour = NA)+
  geom_stars(data = rs_clim_anom, downsample = ds_stars)+
  scico::scale_fill_scico("[days]", 
                          palette = "vik", na.value = NA, direction = -1,
                          rescaler = scales::rescale_mid)+
  coord_sf(expand = F)+
  theme_minimal()+
  xlab(NULL)+ylab(NULL)+
  scale_x_continuous(labels = function(x) paste0(x, "° E"))+
  scale_y_continuous(labels = function(x) paste0(x, "° N"))+
  ggtitle("Anomaly by Elevation [days]",
          "Pixel SCD (snow cover duration) minus the areal average SCD of similarelevation (+-50m)")


```

*** 

Some commentary about Frame 2.



### Explore climate boundaries interactively

```{r}

# histalp data
load(here::here("data/viz_past.Rdata"))
sf_histalp <- readRDS(here::here("data/sf_histalp_extended.rds"))

sf_lines_crs <- sf_histalp[c(1,3), ] %>% 
  st_cast("MULTILINESTRING") %>%
  summarise(geometry = st_combine(geometry)) %>% 
  st_crop(c(xmin = 3, ymin = 42.2, xmax = 20, ymax = 49)) 


sf_lines_t <- histalp_reg_t[c(2,3), ]%>%
  st_cast("MULTILINESTRING") %>%
  summarise(geometry = st_combine(geometry)) %>% 
  st_crop(c(xmin = 4.1, ymin = 43.1, xmax = 19, ymax = 48.7))


sf_lines_p <- histalp_reg_p[c(2,3), ]%>%
  st_cast("MULTILINESTRING") %>%
  summarise(geometry = st_combine(geometry)) %>% 
  st_crop(c(xmin = 4.1, ymin = 43.1, xmax = 19, ymax = 48.7)) 

# colors for mapview
mv5_leaf_col <- colorFactor("Set1", levels = levels(sf_meta$Region))



mapview(sf_meta, zcol = "Region", label = "label",
        col.reg = mv5_leaf_col(sf_meta$Region), 
        layer.name = "Regions (in-situ snow depth)")+
  mapview(sf_lines_crs, 
        layer.name = "HISTALP regions (overall)",
        color = "black",
        label = "summary climatic boundaries")+
  mapview(sf_lines_t, 
          layer.name = "HISTALP regions temperature", 
          color = "#b30000",
          label = "temperature boundaries")+
  mapview(sf_lines_p, 
          layer.name = "HISTALP regions Precipitation", 
          color = "#045a8d",
          label = "precipitation boundaries")

```

*** 

Some commentary about Frame 3.


