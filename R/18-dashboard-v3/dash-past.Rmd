---
title: "CliRSnow"
output: 
  flexdashboard::flex_dashboard:
    self_contained: false
    lib_dir: libs
    theme: bootstrap
    orientation: rows
    vertical_layout: fill
    social: menu
    source: embed
    logo: other/logo_72x48.png
    navbar:
      - { title: "Back to main dashboard", href: "./", align: right }
      - { title: "Back to CliRSnow homepage", href: "/", align: right }
---

```{r setup, include=FALSE}
library(flexdashboard)
# library(leaflet)
library(highcharter)

library(dplyr)
```


# Overview

## Row {.tabset}


```{r overview-data-prep, include=FALSE}

tbl_elev <- readRDS(here::here("data/mountain-background.rds"))
tbl_elev_sub <- tbl_elev[170: 450, ] %>% 
  dplyr::mutate(elev_scaled = ifelse(elev_rollmean > 1000,
                                     elev_rollmean/max(elev_rollmean)*4500,
                                     elev_rollmean))


load(here::here("data/trends.Rdata"))

tbl_xy_pos <- tribble(
  ~x, ~y, ~ns, ~elev_range, 
  200, 500,  "North", "0-1000m",
  420, 500,  "South", "0-1000m",
  220, 1500,  "North", "1000-2000m",
  380, 1500,  "South", "1000-2000m",
  240, 2500,  "North", "2000-3000m",
  360, 2500,  "South", "2000-3000m",
  250, 3500,  "North", ">3000m",
  320, 3500,  "South", ">3000m"
)

tbl_rel <- dat_table_rel %>% 
  left_join(tbl_xy_pos) %>% 
   mutate(label = if_else(y < 3000, sprintf("%+.1f%%", value*49/10), "?"),
         value_size = if_else(y < 3000, abs(value), 0.1),
         label_html = if_else(y > 3000, 
                              div_text_color(label, "#252525"),
                              if_else(value < 0, 
                                      div_text_color(label, "#d7301f"),
                                      div_text_color(label, "#377eb8"))))


div_text_color <- function(text, color){
  paste0("<div style='font-size:14px;color:", color, ";'>", text, "</div>")
}





x <- c("Elevation", "Change")
y <- sprintf("{point.%s:s}", c("elev_range", "label"))

tltip <- tooltip_table(x, y)

cols <- c("#969696", "#1f78b4", "#33a02c")

```



### DJF HS

```{r}


tbl_djf_rel <- dat_trends_rel %>% filter(variable == "meanHS_DJF")


highchart() %>% 
  # hc_add_theme(hc_theme_bloom()) %>% 
  hc_add_theme(hc_theme_hcrt()) %>% 
  hc_add_series(tbl_elev_sub,
                "line",
                hcaes(ii, elev_scaled),
                name = "Mountain",
                enableMouseTracking = F,
                showInLegend = F,
                states = list(inactive = list(opacity = 1))) %>% 
  hc_add_series(tbl_djf_rel,
                "scatter",
                hcaes(x, y, group = ns, size = value_size),
                dataLabels = list(enabled = T,
                                  align = "left",
                                  x = 20,
                                  useHTML = T,
                                  format = "{point.label_html}")) %>% 
  hc_colors(cols) %>%
  hc_legend(align = "center",
            verticalAlign = "top",
            x = -30) %>%
  hc_tooltip(useHTML = T,
             shape = "callout", # or rect
             pointFormat = tltip,
             headerFormat = "") %>% 
  hc_yAxis(title = list(text = "Elevation",
                        rotation = 0,
                        align = "high",
                        offset = 10,
                        y = 10),
           # breaks = c(0:3*1000),
           labels = list(format = "{value:f} m"),
           min = 0, max = 4700,
           # tickAmount = 2,
           tickInterval = 1000,
           endOnTick = F) %>% 
  hc_xAxis(visible = F) %>% 
  hc_title(text = "Change in average winter snow depth 1971-2019") %>% 
  hc_subtitle(text = "Winter is December - February, changes averaged for 1000 m elevation bands") %>% 
  hc_caption(text = strwrap(width = 1e6, 
                            "Changes are determined from linear regressions over the whole period, 
                            and averaged over all stations in 1000 m elevation bands. 
                            Over 3000 m, no stations with such long records exist.")) 



```




### MAM HS


Update in progress...






# Single stn trends


Update in progress...




# Map TS




Update in progress...



